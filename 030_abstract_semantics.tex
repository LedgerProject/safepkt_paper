\section{Abstract Semantics}\label{sec:abstract_semantics}

\begin{definition}[Types]
  The set of \emph{types} over a context $\kappa$ (Def.~\ref{def:context}) is
  \begin{align*}
    \mathsf{T}_\kappa ::=&\ \mathsf{int} & \text{integer}\\
    | &\ \borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \text{borrow}\\
    | &\ \mutborrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \text{mutable borrow}\\
    | &\ \boxtype{\mathsf{T}_\kappa} & \text{box}\\
    | &\ \mathsf{dangling} & \text{dangling}
  \end{align*}
  where $n\ge 1$ and the $\mathsf{w}_i$, with $1\le i\le n$, are leftvalues
  using only variables in $\dom(\kappa)$. This set is ordered by $\sqsubseteq$, defined as
  \begin{align*}
    \mathsf{int}&\sqsubseteq\mathsf{int}\\
    \borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \sqsubseteq
    \borrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} \quad\text{iff $\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\subseteq\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\}$}\\
    \mutborrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \sqsubseteq
    \mutborrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} \quad\text{iff $\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\subseteq\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\}$}\\
    \boxtype{t_1}&\sqsubseteq\boxtype{t_2} \quad\text{iff $t_1\sqsubseteq t_2$}\\
    \mathsf{dangling}&\sqsubseteq\mathsf{dangling.}
  \end{align*}
\end{definition}

\begin{definition}[Copy and move types]\label{def:copy_move}
  Let $t\in\mathsf{T}_\kappa$. Then $t$ \emph{has move semantics}, and we write
  $\movetype(t)$, if and only if $t=\mutborrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}$ or
  $t=\boxtype{t'}$ for some $t'$. In all other cases, $t$ \emph{has copy semantics},
  and we write $\copytype(t)$.
\end{definition}

\begin{lemma}
  \label{lemma:partial-order-types}
  $(\mathsf{T}_\kappa,\sqsubseteq)$ is a partially ordered set.
\end{lemma}
\begin{proof}
  We proceed by structural induction.
  \begin{itemize}
    \item (Reflexivity)
    \begin{itemize}
      \item (Base) For any type $t$ that is not a box we have
      $t\sqsubseteq t$.
      \item (Induction step) If $t\sqsubseteq t$ for a type $t$ then
      $\boxtype{t}\sqsubseteq \boxtype{t}$.
    \end{itemize}
    %
    \item (Antisymmetry) Suppose that $t_1 \sqsubseteq t_2$ and
    $t_2 \sqsubseteq t_1$.
    \begin{itemize}
      \item (Base: $t_1$ or $t_2$ is not a box)
      If $t_1$ or $t_2$ is $\mathsf{int}$, then so is the other
      because $\mathsf{int}$ can only be greater than itself, and so $t_1 = t_2$.
      Similarly if $t_1$ or $t_2$ is $\mathsf{dangling}$.
      If $t_1$ or $t_2$ is a borrow, then so is the other because
      a borrow can only precede a borrow, and so we have $t_1 = t_2$
      by antisymmetry of $\subseteq$.
      Similarly if $t_1$ or $t_2$ is a mutable borrow.
      \item (Induction step) Suppose that $t_1=\boxtype{t'_1}$ and
      $t_2=\boxtype{t'_2}$ for types $t'_1,t'_2$ such that
      $(t'_1 \sqsubseteq t'_2 \land t'_2 \sqsubseteq t'_1) \Rightarrow t'_1 = t'_2$.
      As $t_1 \sqsubseteq t_2$ and $t_2 \sqsubseteq t_1$, we have
      $t'_1 \sqsubseteq t'_2$ and $t'_2 \sqsubseteq t'_1$, so
      $t'_1 = t'_2$, hence $t_1 = t_2$.
    \end{itemize}
    %
    \item (Transitivity) Suppose that $t_1 \sqsubseteq t_2$ and $t_2 \sqsubseteq t_3$.
    \begin{itemize}
      \item (Base: $t_1$, $t_2$ or $t_3$ is not a box)
      If $t_1$, $t_2$ or $t_3$ is $\mathsf{int}$, we necessarily have
      $t_1=t_2=t_3=\mathsf{int}$ because $\mathsf{int}$ is only related to
      itself, and so $t_1\sqsubseteq t_3$. Similarly if
      $t_1$, $t_2$ or $t_3$ is $\mathsf{dangling}$.
      If $t_1$, $t_2$ or $t_3$ is a borrow, then so are the others because
      a borrow is only related to a borrow, and so we have
      $t_1\sqsubseteq t_3$ by transitivity of $\subseteq$.
      Similarly if $t_1$, $t_2$ or $t_3$ is a mutable borrow.
      \item (Induction step) Suppose that $t_1=\boxtype{t'_1}$,
      $t_2=\boxtype{t'_2}$ and $t_3=\boxtype{t'_3}$ for types
      $t'_1,t'_2,t'_3$ such that
      $(t'_1 \sqsubseteq t'_2 \land t'_2 \sqsubseteq t'_3) \Rightarrow
      t'_1 \sqsubseteq t'_3$.
      As $t_1 \sqsubseteq t_2$ and $t_2 \sqsubseteq t_3$, we have
      $t'_1 \sqsubseteq t'_2$ and $t'_2 \sqsubseteq t'_3$, so
      $t'_1 \sqsubseteq t'_3$, hence $t_1 \sqsubseteq t_3$.
    \end{itemize}
  \end{itemize}
  \qed
\end{proof}

\begin{definition}
  The $\sqcap$ operator over $\mathsf{T}_\kappa$ is defined as
  \begin{align*}
    \mathsf{int}\sqcap\mathsf{int} &= \mathsf{int}\\
    \borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} \sqcap \borrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} &= \borrow(\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\cap\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\})\\
    \mutborrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} \sqcap \mutborrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} &= \mutborrow(\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\cap\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\})\\
    (\boxtype{t_1}) \sqcap (\boxtype{t_2}) &=\boxtype{(t_1\sqcap t_2)}\quad\text{if $t_1\sqcap t_2$ is defined}\\
    \mathsf{dangling}\sqcap\mathsf{dangling} &= \mathsf{dangling}.
  \end{align*}
  In all other cases, $t_1\sqcap t_2$ is undefined.
\end{definition}

\begin{lemma}\label{lemma:glb-type}
  Let $I\subseteq\mathbb{N}$ and $\{t_i\}_{i\in I}\subseteq\mathsf{T}_\kappa$.
  Then, if $\sqcap_{i\in I}t_i$ is defined, it is the greatest lower bound of $\{t_i\}_{i\in I}$.
\end{lemma}
\begin{proof}
  Assume that $\mu_I = \sqcap_{i\in I}t_i$ is defined.
  We proceed by structural induction.
  \begin{itemize}
    \item (Base: there is a $t_k$ which is not a box)
    If $t_k=\mathsf{int}$ then, as $\mu_I$ is defined, for all $i\in I$
    we have $t_i=\mathsf{int}$. Therefore, $\mu_I=\mathsf{int}$
    and so $\mu_I$ is a lower bound of $\{t_i\}_{i\in I}$.
    Similarly if $t_k=\mathsf{dangling}$.
    If $t_k$ is a borrow then, for all $i\in I$, $t_i$ is a borrow, and so
    $\mu_I$ is a borrow which results from the intersection of the sets of
    leftvalues of all the $t_i$'s. Hence, $\mu_I$ is a lower bound of
    $\{t_i\}_{i\in I}$.
    Similarly if $t_k$ is a mutable borrow.

    Now, suppose that $\mu'_I$ is also a lower bound of $\{t_i\}_{i\in I}$.
    If $\mu'_I=\mathsf{int}$ then each $t_i$ is $\mathsf{int}$, so
    $\mu_I=\mathsf{int}$ and we have $\mu'_I\sqsubseteq\mu_I$.
    Similarly if $\mu'_I=\mathsf{dangling}$.
    If $\mu'_I=\borrow b$, then for all $i\in I$ we have $t_i = \borrow b_i$
    and $b \subseteq b_i$. Hence, $b \subseteq \cap_{i\in I}b_i$ and so
    $\borrow b \sqsubseteq \borrow\cap_{i\in I}b_i$. Consequently, we have
    $\mu'_I\sqsubseteq\mu_I$ because $\mu_I=\borrow\cap_{i\in I}b_i$ in this case.
    Similarly if $\mu'_I$ is a mutable borrow.
    %
    \item (Induction step) Suppose that for all $i\in I$ we have
    $t_i = \boxtype{t'_i}$. Since $\mu_I$ is defined, also
    $\sqcap_{i\in I}t'_i$ is defined and, by inductive hypothesis, it must be the greatest
    lower bound of $\{t'_i\}_{i\in I}$. Then,
    $\mu_I = \boxtype{(\sqcap_{i\in I}t'_i)}$ is a lower bound
    of $\{t_i\}_{i\in I}$. Suppose that $\mu'_I$ is also a lower bound
    of $\{t_i\}_{i\in I}$. Then, $\mu'_I=\boxtype{t}$ with
    $t\sqsubseteq t'_i$ for all $i\in I$, and so $t$ is a lower bound
    of $\{t'_i\}_{i\in I}$; hence, we have $t\sqsubseteq \sqcap_{i\in I}t'_i$
    because $\sqcap_{i\in I}t'_i$ is the greatest lower bound and,
    consequently, $\mu'_I\sqsubseteq\mu_I$.
  \end{itemize}
  \qed
\end{proof}

\begin{lemma}\label{lemma:technical-type}
  Let $t\in\mathsf{T}_\kappa$. For any $t_1,t_2\in\mathsf{T}_\kappa$,
  if $t\sqsubseteq t_1$ and $t\sqsubseteq t_2$ then $t_1\sqcap t_2$ is defined.
\end{lemma}
\begin{proof}
  We proceed by structural induction on $t$.
  \begin{itemize}
    \item (Base: $t$ is not a box)
    Let $t_1,t_2\in\mathsf{T}_\kappa$ with $t\sqsubseteq t_1$ and $t\sqsubseteq t_2$.
    If $t$ is $\mathsf{int}$ (resp. a borrow, a mutable borrow or $\mathsf{dangling}$)
    then, necessarily, $t_1$ and $t_2$ are $\mathsf{int}$ (resp. a borrow,
    a mutable borrow or $\mathsf{dangling}$), hence $t_1\sqcap t_2$ is defined.
    %
    \item (Induction step) Suppose that $t = \boxtype{t'}$.
    Let $t_1,t_2\in\mathsf{T}_\kappa$ with $t\sqsubseteq t_1$ and $t\sqsubseteq t_2$.
    Then, necessarily, $t_1 = \boxtype{t'_1}$ and $t_2 = \boxtype{t'_2}$
    with $t'\sqsubseteq t'_1$ and $t'\sqsubseteq t'_2$. By induction
    hypothesis, $t'_1\sqcap t'_2$ is defined, so
    $(\boxtype{t'_1}) \sqcap (\boxtype{t'_2}) = t_1 \sqcap t_2$ is defined.
    \qed
  \end{itemize}
\end{proof}

\begin{definition}[Abstract stores]
  \label{def:abstract-store}
  Given a context $\kappa$, an \emph{abstract store} $a$ over $\kappa$ is either $\bot$ or $\top$
  or a set of bindings from variables to types, decorated with a lifetime:
  \[
  a\subseteq\{x\to^m t\mid x\to^m\in\kappa\text{ and }t\in\mathsf{T_\kappa}\}
  \]
  with the constraint that exactly one binding exists for each given variable in $\dom(\kappa)$.
  The set of all abstract stores over $\kappa$ is $\mathbb{AS}_\kappa$.
  The latter is ordered by $\sqsubseteq$, defined as $a_1\sqsubseteq a_2$ iff
  $a_1=\bot$ or $a_2=\top$ or
  ($a_1,a_2\not=\bot,\top$ and for every $x\to^mt_1\in a_1$ there is $x\to^mt_2\in a_2$
  such that $t_1\sqsubseteq t_2$).
\end{definition}

\begin{definition}
  The greatest lower bound operator over $\mathbb{AS}_\kappa$ is defined as
  $\bot\sqcap a=\bot$, $a\sqcap \bot=\bot$, $\top\sqcap a=a$, $a\sqcap\top=a$ and,
  when $a_1,a_2\not=\bot,\top$:
  \[
  a_1\sqcap a_2=\begin{cases}
  \bot\qquad\text{if $\exists x\to^m t_1\in a_1$ and $x\to^m t_2\in a_2$ s.t.\ $t_1\sqcap t_2$ is undefined}\\
  \{x\to^m(t_1\sqcap t_2)\mid x\to^m t_1\in a_1\text{ and }x\to^m t_2\in a_2\}\qquad\text{otherwise.}
  \end{cases}
  \]
\end{definition}

\begin{proposition}\label{prop:complete_lattice}
  The abstract domain $\mathbb{AS}_\kappa$ is a complete lattice \wrt $\sqsubseteq$,
  with $\sqcap$ as greatest lower bound operator.
\end{proposition}
\begin{proof}
  % \issue{TODO}{All this proof should be checked}
  First we prove that $(\mathbb{AS}_\kappa,\sqsubseteq)$ is a partially ordered set.
  \begin{itemize}
    \item (Reflexivity) Let $a\in\mathbb{AS}_\kappa$. If $a=\top$ or $a=\bot$, then
    $a\sqsubseteq a$.
    Otherwise, for every $x\to^mt\in a$ there is $x\to^mt\in a$ with
    $t\sqsubseteq t$ (see Lem.~\ref{lemma:partial-order-types}), hence we have
    $a\sqsubseteq a$.
    %
    \item (Antisymmetry) Suppose that $a_1 \sqsubseteq a_2$ and
    $a_2 \sqsubseteq a_1$. If $a_1=\top$, then, as $a_1 \sqsubseteq a_2$,
    we necessarily have $a_2=\top$, so $a_1=a_2$.
    If $a_1=\bot$ then, as $a_2\sqsubseteq a_1$, we necessarily have $a_2=\bot$,
    so $a_1=a_2$.
    Identically, if $a_2=\top$ or $a_2=\bot$ then we have $a_1=a_2$.
    Now, suppose that $a_1,a_2\not=\top,\bot$. As $a_1 \sqsubseteq a_2$, for every
    $x\to^mt_1\in a_1$ there is $x\to^mt_2\in a_2$ such that
    $t_1\sqsubseteq t_2$ and, as $a_2 \sqsubseteq a_1$, there is
    $x\to^mt'_1\in a_1$ such that $t_2\sqsubseteq t'_1$.
    As in $a_1$ there is exactly one binding for $x\in\dom(\kappa)$, we have
    $t_1=t'_1$. Consequently, $t_1\sqsubseteq t_2$ and $t_2\sqsubseteq t_1$
    so, by Lem.~\ref{lemma:partial-order-types}, $t_1=t_2$. So, we have
    proved that for every $x\to^mt_1\in a_1$ we have $x\to^mt_1\in a_2$.
    Identically, by considering $a_2 \sqsubseteq a_1$, we prove that
    for every $x\to^mt_2\in a_2$ we have $x\to^mt_2\in a_1$.
    Therefore, $a_1=a_2$.
    %
    \item (Transitivity) Suppose that $a_1 \sqsubseteq a_2$ and
    $a_2 \sqsubseteq a_3$.
    If $a_1=\bot$ then $a_1\sqsubseteq a_3$.
    If $a_1=\top$ then $a_2=\top$ and so $a_3=\top$, hence $a_1\sqsubseteq a_3$.
    If $a_2=\bot$ then $a_1=\bot$, so $a_1\sqsubseteq a_3$.
    If $a_2=\top$ then $a_3=\top$, hence $a_1\sqsubseteq a_3$.
    If $a_3=\bot$ then $a_2=\bot$ and so $a_1=\bot$, hence $a_1\sqsubseteq a_3$.
    If $a_3=\top$ then $a_1\sqsubseteq a_3$.
    Now suppose that $a_1,a_2,a_3\not=\top,\bot$.
    Then, for every $x\to^mt_1\in a_1$ there is $x\to^mt_2\in a_2$ such that
    $t_1\sqsubseteq t_2$ and there is $x\to^mt_3\in a_3$ such that
    $t_2\sqsubseteq t_3$. Hence, by Lem.~\ref{lemma:partial-order-types},
    we have $t_1\sqsubseteq t_3$. Therefore, we have $a_1\sqsubseteq a_3$.
  \end{itemize}

  Let $I\subseteq\mathbb{N}$ and $\{a_i\}_{i\in I}\subseteq\mathbb{AS}_\kappa$.
  We prove that $\mu_I=\sqcap_{i\in I}a_i$ is the greatest lower bound of
  $\{a_i\}_{i\in I}$.
  \begin{itemize}
    \item First, we prove that $\mu_I$ is a lower bound.
    Let $k\in I$.
    If $a_k=\top$ then we have $\mu_I \sqsubseteq a_k$.
    If $a_k=\bot$ then $\mu_I=\bot$ and $\mu_I\sqsubseteq a_k$.
    If $\mu_I = \top$ then $\{a_i\}_{i\in I}=\{\top\}$, so we have $a_k=\top$,
    hence $\mu_I \sqsubseteq a_k$.
    If $\mu_I=\bot$ then $\mu_I\sqsubseteq a_k$.
    Otherwise (\textit{ie.} $\mu_I,a_k\neq\top,\bot$),
    let $x\to^m t\in \mu_I$. Then, for all $i\in I$ either
    $a_i=\top$ or there is a binding $x\to^m t_i$ in $a_i$, and we have
    $t = \sqcap_{i\in J}t_i$ where $J=\{i\in I\mid a_i\neq\top\}$. In particular,
    there is a binding $x\to^m t_k$ in $a_k$ and, by Lem.~\ref{lemma:glb-type},
    $\sqcap_{i\in J}t_i \sqsubseteq t_k$. Consequently, we have
    $\mu_I \sqsubseteq a_k$.
    \item Now, we prove that $\mu_I$ is the greatest.
    Suppose that $\mu'_I$ is also a lower bound of $\{a_i\}_{i\in I}$.
    If $\mu'_I=\top$ then necessarily $\{a_i\}_{i\in I}=\{\top\}$, so
    we have $\mu_I=\top$, hence $\mu'_I \sqsubseteq \mu_I$.
    If $\mu'_I=\bot$ or $\mu_I=\top$ then $\mu'_I \sqsubseteq \mu_I$.
    Otherwise, if $\mu_I=\bot$ then either $\bot\in\{a_i\}_{i\in I}$ and so
    $\mu'_I=\bot$, hence $\mu'_I \sqsubseteq \mu_I$; or, for some
    $a_i,a_j$ there is  $x\to^m t_i\in a_i$ and $x\to^m t_j\in a_j$ s.t.\
    $t_i\sqcap t_j$ is undefined; by Lem.~\ref{lemma:technical-type}, this
    is not possible, because there would be exactly one binding
    $x\to^m t\in\mu'_I$ and we would have $t \sqsubseteq t_i$ and
    $t \sqsubseteq t_j$.
    Otherwise (\textit{ie.} $\mu'_I,\mu_I\neq\bot,\top$),
    let $x\to^m t\in \mu'_I$. As $\mu'_I$ is a lower bound of $\{a_i\}_{i\in I}$,
    for all $i\in I$ either $a_i=\top$ or there is $x\to^m t_i\in a_i$ such
    that $t\sqsubseteq t_i$, so $t$ is a lower bound of $\{t_i\}_{i\in J}$
    where $J=\{i\in I\mid a_i\neq\top\}$.
    As $\mu_I\neq\bot$, $\sqcap_{i\in J}t_i$ is defined, so by Lem.~\ref{lemma:glb-type}
    we have $t\sqsubseteq \sqcap_{i\in J}t_i$. Note that
    $x\to^m \sqcap_{i\in J}t_i\in \mu_I$. Therefore, we have
    $\mu'_I \sqsubseteq \mu_I$.
  \end{itemize}

  Finally, $\top$ is the top element of $\mathbb{AS}_\kappa$
  since for every $a\in\mathbb{AS}_\kappa$ we have $a\sqsubseteq\top$.
  Hence there is a least upper bound operator, \issue{induced by $\sqcap$}{Will add reference later},
  and $\mathbb{AS}_\kappa$ is a complete lattice.
  \qed
\end{proof}

\begin{definition}[Concretization map]\label{def:concretization}
  An abstract store $a\in\mathbb{AS}_\kappa$ represents a set of concrete stores
  in $\mathbb{S}_\kappa$, according to the \emph{concretization map}
  $\gamma_\kappa:\mathbb{AS}_\kappa\to\wp(\mathbb{S}_\kappa)$, defined as
  $\gamma_\kappa(\bot)=\varnothing$, $\gamma_\kappa(\top)=\wp(\mathbb{S}_\kappa)$ and,
  for $a\not=\bot,\top$:
  \[
  \gamma_\kappa(a)=\left\{\rho\star h\in\mathbb{S}_\kappa\left|\begin{array}{l}
  \text{for every }x\to^m\ell\in\rho\text{ there is }x\to^m t\in a\text{ s.t.\ }\ell\approx_{\rho\star h}t
  \end{array}
  \right.\right\}
  \]
  where
  \begin{align*}
    \ell&\approx_{\rho\star h}\mathsf{int} && \text{iff $h(\ell)\in\mathbb{Z}$}\\
    \ell&\approx_{\rho\star h}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} && \text{iff $\exists\ell'.\ell\to\ell'\in h$ and}\\
    &&& \forall\mathsf{w}\in\Leftvalues.\left(\loc(\mathsf{w},\rho\star h)=\ell'\text{ implies }\mathsf{w}\in\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\right)\\
    \ell&\approx_{\rho\star h}\mutborrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} && \text{iff $\exists\ell'.\ell\leadsto\ell'\in h$ and}\\
    &&& \forall\mathsf{w}\in\Leftvalues.\left(\loc(\mathsf{w},\rho\star h)=\ell'\text{ implies }\mathsf{w}\in\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\right)\\
    \ell&\approx_{\rho\star h}\boxtype{t} && \text{iff $\exists\ell'.\ell\Rightarrow\ell'\in h$ and $h(\ell')\approx_{\rho\star h}t$}\\
    \ell&\approx_{\rho\star h}\mathsf{dangling} && \text{iff $h(\ell)$ is undefined.}
  \end{align*}
\end{definition}


\begin{lemma}\label{lem:co-additive-type}
  Let $I\subseteq\mathbb{N}$ and $\{t_i\}_{i\in I}\subseteq\mathsf{T}_\kappa$.
  For any $\rho\star h\in\mathbb{S}_\kappa$ and $\ell\in\Locs$,
  \[(\sqcap_{i\in I}t_i \text{ is defined} \land
  \ell\approx_{\rho\star h}\sqcap_{i\in I}t_i)
  \iff \forall i\in I\ \ell\approx_{\rho\star h}t_i\]
\end{lemma}
\begin{proof}
  % \issue{TODO}{Fix Def. 18 (borrows)}
  We proceed by structural induction.
  \begin{itemize}
    \item (Base: there is a $t_k$ which is not a box)
    Let $\rho\star h\in\mathbb{S}_\kappa$ and $\ell\in\Locs$.
    \begin{itemize}
      \item Suppose that $\sqcap_{i\in I}t_i$ is defined and
      $\ell\approx_{\rho\star h}\sqcap_{i\in I}t_i$.
      If $t_k$ is $\mathsf{int}$ (resp. $\mathsf{dangling}$) then,
      as $\sqcap_{i\in I}t_i$ is defined, each $t_i$ is $\mathsf{int}$
      (resp. $\mathsf{dangling}$) and we have $\sqcap_{i\in I}t_i=\mathsf{int}$
      (resp. $\sqcap_{i\in I}t_i=\mathsf{dangling}$).
      Moreover, as $\ell\approx_{\rho\star h}\sqcap_{i\in I}t_i$, we have
      $h(\ell)\in\mathbb{Z}$ (resp. $h(\ell)$ is undefined). Consequently,
      for all $i\in I$ we have $\ell\approx_{\rho\star h}t_i$.
      If $t_k$ is a borrow (resp. mutable borrow) then, as $\sqcap_{i\in I}t_i$
      is defined, each $t_i$ is a borrow (resp. mutable borrow) and
      $\sqcap_{i\in I}t_i=\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}$
      (resp. $\sqcap_{i\in I}t_i=\mutborrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}$)
      is the intersection of the sets of leftvalues of all the $t_i$'s. Moreover, as
      $\ell\approx_{\rho\star h}\sqcap_{i\in I}t_i$, there is a location $\ell'$
      s.t. $\ell\to\ell'\in h$ (resp. $\ell\leadsto\ell'\in h$) and
      for all leftvalue $\mathsf{w}$, $\loc(\mathsf{w},\rho\star h)=\ell'$
      implies $\mathsf{w}\in\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}$. Consequently,
      for all $i\in I$ we have $\ell\approx_{\rho\star h}t_i$ because the set
      of leftvalues of $t_i$ includes $\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}$.
      \item Now, suppose that for all $i\in I$ we have $\ell\approx_{\rho\star h}t_i$.
      If $t_k$ is $\mathsf{int}$ (resp. $\mathsf{dangling}$) then
      $h(\ell)\in\mathbb{Z}$ (resp. $h(\ell)$ is undefined). Consequently,
      for all $i\in I$ we have $t_i = \mathsf{int}$ (resp. $t_i = \mathsf{dangling}$).
      So, $\sqcap_{i\in I}t_i = \mathsf{int}$
      (resp. $\sqcap_{i\in I}t_i=\mathsf{dangling}$) is defined and
      $\ell\approx_{\rho\star h}\sqcap_{i\in I}t_i$.
      If $t_k=\borrow\{\mathsf{w}_{k,1},\ldots,\mathsf{w}_{k,n_k}\}$
      then there is a location $\ell'$ s.t. $\ell\to\ell'\in h$
      and for all leftvalue $\mathsf{w}$,
      $\loc(\mathsf{w},\rho\star h)=\ell'$
      implies $\mathsf{w}\in\{\mathsf{w}_{k,1},\ldots,\mathsf{w}_{k,n_k}\}$.
      %
      So, for all $i\in I$, $t_i$ has the form
      $\borrow\{\mathsf{w}_{i,1},\ldots,\mathsf{w}_{i,n_i}\}$
      and for all leftvalue $\mathsf{w}$, $\loc(\mathsf{w},\rho\star h)=\ell'$
      implies $\mathsf{w}\in\{\mathsf{w}_{i,1},\ldots,\mathsf{w}_{i,n_i}\}$. So,
      $\sqcap_{i\in I}t_i = \borrow(\cap_{i\in I}\{\mathsf{w}_{i,1},\ldots,\mathsf{w}_{i,n_i}\})$
      is defined and $\ell\approx_{\rho\star h}\sqcap_{i\in I}t_i$.
      Similarly if $t_k=\mutborrow\{\mathsf{w}_{k,1},\ldots,\mathsf{w}_{k,n_k}\}$.
    \end{itemize}
    %
    \item (Induction step) Suppose that $t_i=\boxtype{t'_i}$ for all
    $i\in I$. Let $\rho\star h\in\mathbb{S}_\kappa$ and $\ell\in\Locs$.
    \begin{itemize}
      \item If $\sqcap_{i\in I}t_i$ is defined and
      $\ell\approx_{\rho\star h}\sqcap_{i\in I}t_i$ then
      $\sqcap_{i\in I}t_i = \boxtype{(\sqcap_{i\in I}t'_i)}$ and
      $\sqcap_{i\in I}t'_i$ is defined. Moreover, there is a location $\ell'$
      s.t. $\ell\Rightarrow\ell'\in h$ and
      $h(\ell')\approx_{\rho\star h}\sqcap_{i\in I}t'_i$. Consequently,
      by induction hypothesis, for all $i\in I$ we have
      $h(\ell')\approx_{\rho\star h}t'_i$. Therefore, for all $i\in I$ we have
      $\ell\approx_{\rho\star h}\boxtype{t'_i}$ \ie
      $\ell\approx_{\rho\star h}t_i$.
      \item Now, suppose that for all $i\in I$ we have $\ell\approx_{\rho\star h}t_i$
      \ie $\ell\approx_{\rho\star h}\boxtype{t'_i}$. Then, for all $i\in I$,
      there is a location $\ell'_i$ s.t. $\ell\Rightarrow\ell'_i\in h$ and
      $h(\ell'_i)\approx_{\rho\star h}t'_i$.
      Note that all the $\ell'_i$'s are equal to a same location $\ell'$ because,
      by definition of a heap, there is at most a binding in $h$ for location
      $\ell$. By induction hypothesis, $\sqcap_{i\in I}t'_i$ is defined and
      $h(\ell')\approx_{\rho\star h}\sqcap_{i\in I}t'_i$.
      Consequently, $\sqcap_{i\in I}t_i = \sqcap_{i\in I} (\boxtype{t'_i}) =
      \boxtype{(\sqcap_{i\in I}t'_i)}$ is defined and
      $\ell\approx_{\rho\star h}\boxtype{(\sqcap_{i\in I}t'_i)}$ \ie
      $\ell\approx_{\rho\star h}\sqcap_{i\in I}t_i$.
      \qed
    \end{itemize}
  \end{itemize}
\end{proof}

\begin{lemma}\label{lem:co-additive}
  The map $\gamma_\kappa$ of Def.~\ref{def:concretization} is co-additive.
\end{lemma}
\begin{proof}
  % \issue{TODO}{This proof should be redone}
  Let $I\subseteq\mathbb{N}$ and $\{a_i\}_{i\in I}\subseteq\mathbb{AS}_\kappa$.
  We prove that $\gamma_\kappa(\sqcap_{i\in I}a_i)=\cap_{i\in I}\gamma_\kappa(a_i)$.
  \begin{itemize}
    \item If $\sqcap_{i\in I}a_i=\top$, then for all $i\in I$ we have $a_i=\top$.
    Hence, $\gamma_\kappa(\sqcap_{i\in I}a_i) =
    \gamma_\kappa(\top) =
    \wp(\mathbb{S}_\kappa) =
    \cap_{i\in I}\wp(\mathbb{S}_\kappa) =
    \cap_{i\in I}\gamma_\kappa(\top) =
    \cap_{i\in I}\gamma_\kappa(a_i)$.
    \item Suppose that $\sqcap_{i\in I}a_i=\bot$. Then, either there is $i\in I$ s.t.
    $a_i=\bot$, and so $\gamma_\kappa(\sqcap_{i\in I}a_i) = \varnothing =
    \cap_{i\in I}\gamma_\kappa(a_i)$. Or, for some $a_j,a_k\not=\top,\bot$
    there is $x\to^m t_j\in a_j$ and $x\to^m t_k\in a_k$ s.t.
    $t_j\sqcap t_k$ is undefined. Let us show that
    $\gamma_\kappa(a_j)\cap\gamma_\kappa(a_k)=\varnothing$.
    Let $\rho\star h\in\gamma_\kappa(a_j)$.
    Necessarily, there is a binding $x\to^m\ell$ in $\rho$ and
    we have $\ell\approx_{\rho\star h}t_j$.
    Consequently, by Lem.~\ref{lem:co-additive-type},
    $\ell\approx_{\rho\star h}t_k$ does not hold, so
    $\rho\star h\not\in\gamma_\kappa(a_k)$.
    Finally, we have $\cap_{i\in I}\gamma_\kappa(a_i) = \varnothing =
    \gamma_\kappa(\sqcap_{i\in I}a_i)$.
  \end{itemize}
  From now on, we suppose that $\sqcap_{i\in I}a_i\not=\top,\bot$.
  Then, necessarily, for all $i\in I$ we have $a_i\not=\bot$.
  Moreover, $J=\{i\in I\mid a_i\neq\top\}\not=\varnothing$ and
  $\sqcap_{i\in I}a_i = \sqcap_{i\in J}a_i$ and
  $\cap_{i\in I}\gamma_\kappa(a_i)=\cap_{i\in J}\gamma_\kappa(a_i)$.
  \begin{itemize}
    \item First we prove that
    $\gamma_\kappa(\sqcap_{i\in J}a_i)\subseteq\cap_{i\in J}\gamma_\kappa(a_i)$.
    Let $\rho\star h\in\gamma_\kappa(\sqcap_{i\in J}a_i)$.
    Let $x\to^m\ell\in\rho$. Then, there is $x\to^m t\in \sqcap_{i\in J}a_i$ s.t.
    $\ell\approx_{\rho\star h}t$. By definition of $\sqcap$, for all $i\in J$
    there is $x\to^m t_i\in a_i$, and $t=\sqcap_{i\in J}t_i$ is defined.
    By Lem.~\ref{lem:co-additive-type}, $\ell\approx_{\rho\star h}t_i$
    for all $i\in J$. Therefore, $\rho\star h\in\gamma_\kappa(a_i)$
    for all $i\in J$. Consequently,
    $\rho\star h\in\cap_{i\in J}\gamma_\kappa(a_i)$.
    \item Now we prove that
    $\gamma_\kappa(\sqcap_{i\in J}a_i)\supseteq\cap_{i\in J}\gamma_\kappa(a_i)$.
    Let $\rho\star h\in\cap_{i\in J}\gamma_\kappa(a_i)$.
    Let $x\to^m\ell\in\rho$.
    For all $i\in J$, $\rho\star h\in\gamma_\kappa(a_i)$ and there
    is $x\to^m t_i\in a_i$ s.t. $\ell\approx_{\rho\star h}t_i$.
    % As $\sqcap_{i\in I}a_i\not=\bot$, $\sqcap_{i\in J}t_i$ is defined
    So, by Lem.~\ref{lem:co-additive-type}, $\sqcap_{i\in J}t_i$ is defined
    and $\ell\approx_{\rho\star h}\sqcap_{i\in J}t_i$.
    Moreover, $x\to^m \sqcap_{i\in J}t_i \in \sqcap_{i\in J}a_i$.
    Consequently, we have $\rho\star h\in\gamma_\kappa(\sqcap_{i\in J}a_i)$.
  \end{itemize}
  \qed
\end{proof}

\begin{proposition}\label{prop:abstract_interpretation}
  The domain $\mathbb{AS}_\kappa$ is an abstract interpretation of $\wp(\mathbb{S}_\kappa)$
  with $\gamma_\kappa$ as concretization map.
\end{proposition}
\begin{proof}
  The abstract domain $\mathbb{AS}_\kappa$ is a complete lattice \wrt $\sqsubseteq$
  with $\sqcap$ as greatest lower bound operator (Prop.~\ref{prop:complete_lattice}).
  The domain $\wp(\mathbb{S}_\kappa)$ is a complete lattice \wrt $\subseteq$ with $\cap$ as
  greatest lower bound operator. The map $\gamma_\kappa$ is co-additive (Lem.~\ref{lem:co-additive}).
  The thesis follows by a general result of abstract interpretation~\cite{CousotC77}.
  \qed
\end{proof}

\begin{definition}[Abstract location for reading]\label{def:abstract_location_for_reading}
  Let $\mathsf{w}\in\Leftvalues$ and $a\in\mathbb{AS}_\kappa$. The partial function
  $\locreada(\mathsf{w},a)$ yields the type of the location that holds the value of $\mathsf{w}$
  and a Boolean mark that informs if the evaluation of $\mathsf{w}$ passes through a borrow:
  \begin{align*}
    \locreada(x,a)&=\langle a(x),\mathit{false}\rangle\\
    \locreada(*\mathsf{w},a)&=\begin{cases}
    \text{undefined} & \text{if $\locreada(\mathsf{w},a)$ is undefined}\\
    \text{undefined} & \text{if $\locreada(\mathsf{w},a)=\langle\mathsf{dangling},b\rangle$}\\
    \text{undefined} & \text{if $\locreada(\mathsf{w},a)=\langle\mathsf{int},b\rangle$}\\
    \langle t_1\sqcup\cdots\sqcup t_n,\mathit{true}\rangle & \text{if $\locreada(\mathsf{w},a)=\langle\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\},b\rangle$,}\\
    &\quad\text{$\forall i\in\{1,\ldots,n\}.\locreada(\mathsf{w}_i,a)=\langle t_i,b_i\rangle$}\\
    &\quad\text{and $t_1\sqcup\cdots\sqcup t_n$ exists}\\
    \langle t_1\sqcup\cdots\sqcup t_n,\mathit{true}\rangle & \text{if $\locreada(\mathsf{w},a)=\langle\mutborrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\},b\rangle$,}\\
    &\quad\text{$\forall i\in\{1,\ldots,n\}.\locreada(\mathsf{w}_i,a)=\langle t_i,b_i\rangle$}\\
    &\quad\text{and $t_1\sqcup\cdots\sqcup t_n$ exists}\\
    \langle t,b\rangle & \text{if $\locreada(\mathsf{w},a)=\langle\boxtype{t},b\rangle$}\\
    \text{undefined} & \text{otherwise.}
    \end{cases}
  \end{align*}
\end{definition}

\begin{definition}[Abstract location]\label{def:abstract_location}
  Let $\mathsf{w}\in\Leftvalues$ and $a\in\mathbb{AS}_\kappa$. The partial function
  $\loca(\mathsf{w},a)$ yields the type of the location holding the value of $\mathsf{w}$:
  \[
  \loca(\mathsf{w},a)=\begin{cases}
  \text{undefined} & \text{if $\locreada(\mathsf{w},a)$ is undefined}\\
  t & \text{if $\locreada(\mathsf{w},a)=\langle t,b\rangle$.}
  \end{cases}
  \]
\end{definition}

\begin{definition}[Abstract undefined leftvalues]\label{def:abstract_undefined_leftvalues}
  Let $\mathsf{w}\in\Leftvalues$ and $a\in\mathbb{AS}_\kappa$. Then
  $\mathsf{w}$ is \emph{undefined} in $a$ if $\loca(\mathsf{w},a)$ is undefined
  or $\loca(\mathsf{w},a)=\mathsf{dangling}$.
\end{definition}

\begin{proposition}[Abstract undefined is correct]
  \label{prop:abstract_undefined_correctness}
  Let $\mathsf{w}\in\Leftvalues$, $s\in\mathbb{S}_\kappa$
  and $a\in\mathbb{AS}_\kappa$ be
  such that $s\in\gamma_\kappa(a)$.
  If $\mathsf{w}$ is undefined in $s$ then $\mathsf{w}$ is undefined in $a$.
\end{proposition}
\begin{proof}
  % TODO
  Suppose that $\mathsf{w}$ is undefined in $s=\rho\star h$. Then,
  by Def.~\ref{def:undefined_leftvalues}, there are
  two possibilities: either $\loc(\mathsf{w},s)$ is undefined or it is
  dangling in $s$. We proceed by structural induction on $\mathsf{w}$.
  \begin{itemize}
    \item (Base: $\mathsf{w}\in\dom(\kappa)$)
    There is exactly one binding in $\rho$ for each variable in
    $\dom(\kappa)$, so there is $\mathsf{w}\to\ell\in\rho$.
    By Def.~\ref{def:location_for_reading} and Def.~\ref{def:location},
    we have $\loc(\mathsf{w},s)=\ell$. Hence, $\loc(\mathsf{w},s)$ is defined.
    Consequently, as $\mathsf{w}$ is undefined in $s$, necessarily
    $\loc(\mathsf{w},s)=\ell$ is dangling in $s$, so $h(\ell)$ is
    undefined. Moreover, as $s\in\gamma_\kappa(a)$, there is
    $\mathsf{w}\to^m t\in a$ s.t. $\ell\approx_{\rho\star h}t$.
    As $h(\ell)$ is undefined, we have $t=\mathsf{dangling}$.
    Finally, $\locreada(\mathsf{w},a)=\langle a(\mathsf{w}),\mathit{false}\rangle
    =\langle \mathsf{dangling},\mathit{false}\rangle$, so
    $\loca(\mathsf{w},a)=\mathsf{dangling}$. Therefore, $\mathsf{w}$ is
    undefined in $a$.
    %
    \item (Induction step) Suppose that $\mathsf{w} = \mathtt{*}\mathsf{w}'$.
    First, assume that $\loc(\mathsf{w},s)$ is undefined. Then,
    by Def.~\ref{def:location_for_reading} and Def.~\ref{def:location}, there
    are three possibilities.
    \begin{itemize}
      \item Either $\locread(\mathsf{w'},s)$ is undefined. This implies that
      $\mathsf{w}'$ is undefined in $s$ so, by induction hypothesis, that
      $\mathsf{w}'$ is undefined in $a$. Then, either $\loca(\mathsf{w'},a)$ is
      undefined; this implies that $\locreada(\mathsf{w'},a)$ is undefined, and
      so that $\locreada(\mathsf{w},a)$ is undefined; hence
      $\loca(\mathsf{w},a)$ is undefined, hence $\mathsf{w}$ is undefined in $a$.
      Or, $\loca(\mathsf{w'},a)=\mathsf{dangling}$; then,
      $\locreada(\mathsf{w'},a)=\langle\mathsf{dangling},b\rangle$, hence
      $\locreada(\mathsf{w},a)$ is undefined, so $\loca(\mathsf{w},a)$ is
      undefined; consequently, $\mathsf{w}$ is undefined in $a$.
      \item Or $\locread(\mathsf{w'},s)=\langle\ell,b\rangle$ and
      $h(\ell)$ is undefined. Then, $\loc(\mathsf{w'},s)=\ell$ is dangling
      in $s$, so $\mathsf{w'}$ is undefined in $s$. Consequently, by induction
      hypothesis, $\mathsf{w}'$ is undefined in $a$. By proceeding as above,
      one concludes that $\mathsf{w}$ is undefined in $a$.
      \item Or $\locread(\mathsf{w'},s)=\langle\ell,b\rangle$ and
      $h(\ell)\in\mathbb{Z}$. Then, $\ell \approx_s \mathsf{int}$
    \end{itemize}
    Now, assume that $\loc(\mathsf{w},s)$ is dangling in $s$. Then,
    $h(\loc(\mathsf{w},s))$ is undefined, so
    $\loc(\mathsf{w},s) \approx_s \mathsf{dangling}$.
    \qed
  \end{itemize}
\end{proof}

The concrete semantics uses a precise notion of borrowed locations
(Def.~\ref{def:borrow}). The abstract semantics has abstracted away the concrete locations
and can only use types for determining when a value might be borrowed, which leads
to a coarser notion of \emph{abstract} borrowing for leftvalues (that is, for their value).

\begin{definition}\label{def:abstract_borrow}
  Let $a\in\mathbb{AS}_\kappa$ and $\mathsf{w}\in\Leftvalues$.
  Then $\mathsf{w}$ is
  \emph{borrowed as immutable} in $a$ if there exists $v\in\dom(\kappa)$ such that
  $\beta_\to(a(v),\mathsf{w})$ holds, where
  \begin{align*}
    \beta_\to(\mathsf{int},\mathsf{w})&=\mathit{false}\\
    \beta_\to(\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\},\mathsf{w})&=\exists i.(\mathsf{root}(\mathsf{w}_i)=\mathsf{root}(\mathsf{w}))\\
    \beta_\to(\mutborrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\},\mathsf{w})&=\mathit{false}\\
    \beta_\to(\boxtype{t},\mathsf{w})&=\beta_\to(t,\mathsf{w})\\
    \beta_\to(\mathtt{dangling},\mathsf{w})&=\mathit{false.}
  \end{align*}
  Moreover, $\mathsf{w}$ is
  \emph{borrowed as mutable} in $a$ if there exists $v\in\dom(\kappa)$ such that
  $\beta_\leadsto(a(v),\mathsf{w})$ holds, where
  \begin{align*}
    \beta_\leadsto(\mathsf{int},\mathsf{w})&=\mathit{false}\\
    \beta_\leadsto(\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\},\mathsf{w})&=\mathit{false}\\
    \beta_\leadsto(\mutborrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\},\mathsf{w})&=\exists i.(\mathsf{root}(\mathsf{w}_i)=\mathsf{root}(\mathsf{w}))\\
    \beta_\leadsto(\boxtype{t},\mathsf{w})&=\beta_\leadsto(t,\mathsf{w})\\
    \beta_\leadsto(\mathtt{dangling},\mathsf{w})&=\mathit{false.}
  \end{align*}
  Finally, $\mathsf{w}$ is \emph{borrowed} in $a$ if it is borrowed either as immutable
  or as mutable in $a$.
\end{definition}

\begin{proposition}[Abstract borrowing is correct]
  \label{prop:abstract_borrow_correctness}
  Let $\mathsf{w}\in\Leftvalues_\kappa$, $s\in\mathbb{S}_\kappa$
  and $a\in\mathbb{AS}_\kappa$ be
  such that $s\in\gamma_\kappa(a)$.
  If $\mathsf{w}$ is borrowed as immutable in $s$, then
  $\mathsf{w}$ is borrowed as immutable in $a$.
  If $\mathsf{w}$ is borrowed as mutable in $s$, then
  $\mathsf{w}$ is borrowed as mutable in $a$.
  If $\mathsf{w}$ is borrowed in $s$, then
  $\mathsf{w}$ is borrowed in $a$.
\end{proposition}
\begin{proof}
  TODO
\end{proof}

The abstract evaluation of an expression yields the abstraction of the
value of the expression, a potentially updated abstract store
and an arrow that expresses the nature of the value: an owned value, an immutable borrow
or a mutable borrow. Let us start from the leftvalues, then consider the other kinds of
expressions.

\begin{definition}[Abstract semantics of leftvalues]\label{def:abstract_semantics_leftvalues}
  Let $a\in\mathbb{AS}_\kappa$ and $\mathsf{w}\in\Leftvalues_\kappa$. Then
  \[
  \dena[\mathsf{w}]{a}=\begin{cases}
  \text{undefined} & \text{if $\mathsf{w}$ is undefined in $a$}\\
  \text{undefined} & \text{otherwise, if $\mathsf{w}$ is borrowed as mutable in $a$}\\
  \langle t, a\rangle & \text{otherwise, if $t=\loca(\mathsf{w},a)$ and $\copytype(t)$}\\
  \langle t, a[x\to^m\underbrace{\boxempty\cdots\boxempty}_{n\text{ times}}\mathsf{dangling}]\rangle & \text{otherwise, if $\langle t,\mathit{false}\rangle=\locreada(\mathsf{w},a)$ and $\movetype(t)$,}\\
  & \quad\text{where $\mathsf{w}=\underbrace{*\ldots*}_{n\text{ times}}x$ and $x\to^mt'\in a$}\\
  \text{undefined} & \text{otherwise.}
  \end{cases}
  \]
\end{definition}

\begin{proposition}[The abstract semantics of leftvalues is correct]
  \label{prop:abstract_leftvalues_correctness}
  Let $\mathsf{w}\in\Leftvalues_\kappa$, $s\in\mathbb{S}_\kappa$
  and $a\in\mathbb{AS}_\kappa$ be
  such that $s\in\gamma_\kappa(a)$.
  Then $\den[\mathsf{w}]{s}\in\gamma_\kappa(\dena[\mathsf{w}]{a})$.
\end{proposition}
\begin{proof}
  TODO
\end{proof}
