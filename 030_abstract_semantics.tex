\section{Abstract Semantics}\label{sec:abstract_semantics}

\begin{definition}[Types]
  The set of \emph{types} over a context $\kappa$ (Def.~\ref{def:context}) is
  \begin{align*}
    \mathsf{T}_\kappa ::=&\ \mathsf{int} & \text{integer}\\
    | &\ \borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \text{borrow}\\
    | &\ \mathtt{mut}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \text{mutable borrow}\\
    | &\ \mathtt{box}\ \mathsf{T}_\kappa & \text{box}\\
    | &\ \bot & \text{undefined}
  \end{align*}
  where $n\ge 1$ and the $\mathsf{w}_i$, with $1\le i\le n$, are leftvalues
  using only variables in $\dom(\kappa)$. This set is ordered by $\sqsubseteq$, defined as
  \begin{align*}
    \mathsf{int}&\sqsubseteq\mathsf{int}\\
    \borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \sqsubseteq
    \borrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} \quad\text{iff $\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\subseteq\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\}$}\\
    \mathtt{mut}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \sqsubseteq
    \mathtt{mut}\borrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} \quad\text{iff $\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\subseteq\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\}$}\\
    \mathtt{box}\ t_1&\sqsubseteq\mathtt{box}\ t_2 \quad\text{iff $t_1\sqsubseteq t_2$}\\
    \bot&\sqsubseteq t\qquad\text{for every $t$.}
  \end{align*}
\end{definition}

\begin{lemma}
  \label{lemma:partial-order-types}
  $(\mathsf{T}_\kappa,\sqsubseteq)$ is a partially ordered set.
\end{lemma}
\begin{proof}
  We prove that $\sqsubseteq$ is reflexive, antisymmetric and transitive.
  We proceed by structural induction.
  \begin{itemize}
    \item (Reflexivity)
    \begin{itemize}
      \item (Base) For any type $t$ that is not a box we have
      $t\sqsubseteq t$.
      \item (Induction step) If $t\sqsubseteq t$ for a type $t$ then
      $\mathtt{box}\ t\sqsubseteq \mathtt{box}\ t$.
    \end{itemize}
    %
    \item (Antisymmetry) Suppose that $t_1 \sqsubseteq t_2$ and
    $t_2 \sqsubseteq t_1$.
    \begin{itemize}
      \item (Base: $t_1$ or $t_2$ is not a box)
      If $t_1$ or $t_2$ is $\bot$, then so is the other
      because $\bot$ can only be greater than itself, and so $t_1 = t_2$.
      If $t_1$ or $t_2$ is $\mathsf{int}$, then so is the other
      because $\mathsf{int}$ can only precede itself, and so $t_1 = t_2$.
      If $t_1$ or $t_2$ is a borrow, then so is the other because
      a borrow can only precede a borrow, and so we have $t_1 = t_2$
      by antisymmetry of $\subseteq$.
      Identically, if $t_1$ or $t_2$ is a mutable borrow, we have $t_1 = t_2$.
      \item (Induction step) Suppose that $t_1=\mathtt{box}\ t'_1$ and
      $t_2=\mathtt{box}\ t'_2$ for types $t'_1,t'_2$ such that
      $(t'_1 \sqsubseteq t'_2 \land t'_2 \sqsubseteq t'_1) \Rightarrow t'_1 = t'_2$.
      As $t_1 \sqsubseteq t_2$ and $t_2 \sqsubseteq t_1$, we have
      $t'_1 \sqsubseteq t'_2$ and $t'_2 \sqsubseteq t'_1$, so
      $t'_1 = t'_2$, hence $t_1 = t_2$.
    \end{itemize}
    %
    \item (Transitivity) Suppose that $t_1 \sqsubseteq t_2$ and
    $t_2 \sqsubseteq t_3$.
    \begin{itemize}
      \item (Base: $t_1$, $t_2$ or $t_3$ is not a box)
      If $t_1=\bot$, then $t_1\sqsubseteq t_3$.
      If $t_2=\bot$, then $t_1=\bot$, so $t_1\sqsubseteq t_3$.
      If $t_3=\bot$, then $t_2=\bot$, so $t_1=\bot$, hence $t_1\sqsubseteq t_3$.
      Now, suppose that none of $t_1,t_2,t_3$ is $\bot$.
      Then, if $t_1$, $t_2$ or $t_3$ is $\mathsf{int}$, we necessarily have
      $t_1=t_2=t_3=\mathsf{int}$ because $\mathsf{int}$ is only related to
      itself or to $\bot$, and so $t_1\sqsubseteq t_3$.
      If $t_1$, $t_2$ or $t_3$ is a borrow, then so are the others because
      a borrow is only related to a borrow or to $\bot$, and so we have
      $t_1\sqsubseteq t_3$ by transitivity of $\subseteq$.
      Identically, if $t_1$, $t_2$ or $t_3$ is a mutable borrow, we have
      $t_1\sqsubseteq t_3$.
      \item (Induction step) Suppose that $t_1=\mathtt{box}\ t'_1$,
      $t_2=\mathtt{box}\ t'_2$ and $t_3=\mathtt{box}\ t'_3$ for types
      $t'_1,t'_2,t'_3$ such that
      $(t'_1 \sqsubseteq t'_2 \land t'_2 \sqsubseteq t'_3) \Rightarrow
      t'_1 \sqsubseteq t'_3$.
      As $t_1 \sqsubseteq t_2$ and $t_2 \sqsubseteq t_3$, we have
      $t'_1 \sqsubseteq t'_2$ and $t'_2 \sqsubseteq t'_3$, so
      $t'_1 \sqsubseteq t'_3$, hence $t_1 \sqsubseteq t_3$.
    \end{itemize}
  \end{itemize}
\end{proof}

\begin{definition}
  The greatest lower bound operator over $\mathsf{T}_\kappa$ is defined as
  \begin{align*}
    \mathsf{int}\sqcap\mathsf{int} &= \mathsf{int}\\
    \borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} \sqcap \borrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} &= \borrow b\\
    & \text{if $b=\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\cap\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\}\not=\varnothing$}\\
    \mathtt{mut}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} \sqcap \mathtt{mut}\borrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} &= \mathtt{mut}\borrow b\\
    & \text{if $b=\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\cap\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\}\not=\varnothing$}\\
    (\mathtt{box}\ t_1) \sqcap (\mathtt{box}\ t_2) &=\mathtt{box}\ (t_1\sqcap t_2).
  \end{align*}
  In all other cases, $t_1\sqcap t_2=\bot$.
\end{definition}

\begin{lemma}\label{lemma:glb-type}
  Let $I\subseteq\mathbb{N}$ and $\{t_i\}_{i\in I}\subseteq\mathsf{T}_\kappa$.
  Then, $\sqcap_{i\in I}t_i$ is the greatest lower bound of $\{t_i\}_{i\in I}$.
\end{lemma}
\begin{proof}
\end{proof}

\begin{definition}[Abstract stores]
  \label{def:abstract-store}
  Given a context $\kappa$, an \emph{abstract store} $a$ over $\kappa$ is either $\top$
  or a set of bindings from variables to types, decorated with a lifetime:
  \[
  a\subseteq\{x\to^m t\mid x\to^m\in\kappa\text{ and }t\in\mathsf{T_\kappa}\}
  \]
  with the constraint that exactly one binding exists for each given variable in $\dom(\kappa)$.
  The set of all abstract stores over $\kappa$ is $\mathbb{AS}_\kappa$.
  The latter is ordered by $\sqsubseteq$, defined as $a_1\sqsubseteq a_2$ iff $a_2=\top$ or
  ($a_1,a_2\not=\top$ and for every $x\to^mt_1\in a_1$ there is $x\to^mt_2\in a_2$
  such that $t_1\sqsubseteq t_2$).
\end{definition}

\begin{definition}
  The greatest lower bound operator over $\mathbb{AS}_\kappa$ is defined as
  $a\sqcap\top=a$, $\top\sqcap a=a$ and, when $a_1,a_2\not=\top$,
  \[
  a_1\sqcap a_2=\{x\to^m(t_1\sqcap t_2)\mid x\to^m t_1\in a_1\text{ and }x\to^m t_2\in a_2\}.
  \]
\end{definition}

\begin{proposition}\label{prop:complete_lattice}
  The abstract domain $\mathbb{AS}_\kappa$ is a complete lattice \wrt $\sqsubseteq$,
  with $\sqcap$ as greatest lower bound operator.
\end{proposition}
\begin{proof}
  First we prove that $(\mathbb{AS}_\kappa,\sqsubseteq)$ is a partially
  ordered set.
  \begin{itemize}
    \item (Reflexivity) Let $a\in\mathbb{AS}_\kappa$. If $a=\top$, then
    $a\sqsubseteq a$. Otherwise, if $a$ is empty, then $a\sqsubseteq a$ holds
    vacuously. Otherwise, for every $x\to^mt\in a$ there is $x\to^mt\in a$ with
    $t\sqsubseteq t$ (see Lem.~\ref{lemma:partial-order-types}), hence we have
    $a\sqsubseteq a$.
    %
    \item (Antisymmetry) Suppose that $a_1 \sqsubseteq a_2$ and
    $a_2 \sqsubseteq a_1$. If $a_2=\top$, then, as $a_2 \sqsubseteq a_1$,
    we necessarily have $a_1=\top$, so $a_1=a_2$. Otherwise, we necessarily
    have $a_1\neq\top$. Moreover, as $a_1 \sqsubseteq a_2$, for every
    $x\to^mt_1\in a_1$ there is $x\to^mt_2\in a_2$ such that
    $t_1\sqsubseteq t_2$ and, as $a_2 \sqsubseteq a_1$, there is
    $x\to^mt'_1\in a_1$ such that $t_2\sqsubseteq t'_1$.
    As in $a_1$ there is exactly one binding for $x\in\dom(\kappa)$, we have
    $t_1=t'_1$. Consequently, $t_1\sqsubseteq t_2$ and $t_2\sqsubseteq t_1$
    so, by Lem.~\ref{lemma:partial-order-types}, $t_1=t_2$. So, we have
    proved that for every $x\to^mt_1\in a_1$ we have $x\to^mt_1\in a_2$.
    Identically, by considering $a_2 \sqsubseteq a_1$, we prove that
    for every $x\to^mt_2\in a_2$ we have $x\to^mt_2\in a_1$.
    Therefore, $a_1=a_2$.
    %
    \item (Transitivity) Suppose that $a_1 \sqsubseteq a_2$ and
    $a_2 \sqsubseteq a_3$. If $a_3=\top$, then we have $a_1\sqsubseteq a_3$.
    Otherwise, as $a_2 \sqsubseteq a_3$, we have $a_2\neq\top$ and so, as
    $a_1 \sqsubseteq a_2$, we also have $a_1\neq\top$. Consequently, for every
    $x\to^mt_1\in a_1$ there is $x\to^mt_2\in a_2$ such that
    $t_1\sqsubseteq t_2$ and there is $x\to^mt_3\in a_3$ such that
    $t_2\sqsubseteq t_3$. Hence, by Lem.~\ref{lemma:partial-order-types},
    we have $t_1\sqsubseteq t_3$. Therefore, we have $a_1\sqsubseteq a_3$.
  \end{itemize}

  Let $I\subseteq\mathbb{N}$ and $\{a_i\}_{i\in I}\subseteq\mathbb{AS}_\kappa$.
  We prove that $\mu_I=\sqcap_{i\in I}a_i$ is the greatest lower bound of
  $\{a_i\}_{i\in I}$.
  \begin{itemize}
    \item First, we prove that $\mu_I$ is a lower bound.
    Let $k\in I$. If $\mu_I$ is empty or $a_k=\top$ then we have
    $\mu_I \sqsubseteq a_k$. If $\mu_I = \top$ then $\{a_i\}_{i\in I}=\{\top\}$,
    so we have $a_k=\top$, hence $\mu_I \sqsubseteq a_k$.
    Otherwise (\textit{ie.} $\mu_I\neq\emptyset$, $\mu_I\neq\top$ and
    $a_k\neq\top$), let $x\to^m t\in \mu_I$. Then, for all $i\in I$ either
    $a_i=\top$ or there is a binding $x\to^m t_i$ in $a_i$, and we have
    $t = \sqcap_{i\in J}t_i$ where $J=\{i\in I\mid a_i\neq\top\}$. In particular,
    there is a binding $x\to^m t_k$ in $a_k$ and, by Lem.~\ref{lemma:glb-type},
    $\sqcap_{i\in J}t_i \sqsubseteq t_k$. Consequently, we have
    $\mu_I \sqsubseteq a_k$.
    \item Now, we prove that $\mu_I$ is the greatest.
    Suppose that $\mu'_I$ is also a lower bound of $\{a_i\}_{i\in I}$.
    If $\mu'_I$ is empty or $\mu_I=\top$ then $\mu'_I \sqsubseteq \mu_I$.
    If $\mu'_I=\top$ then necessarily $\{a_i\}_{i\in I}=\{\top\}$, so
    we have $\mu_I=\top$, hence $\mu'_I \sqsubseteq \mu_I$.
    Otherwise (\textit{ie.} $\mu'_I\neq\emptyset$, $\mu'_I\neq\top$
    and $\mu_I\neq\top$),
    let $x\to^m t\in \mu'_I$. As $\mu'_I$ is a lower bound of $\{a_i\}_{i\in I}$,
    for all $i\in I$ either $a_i=\top$ or there is $x\to^m t_i\in a_i$ such
    that $t\sqsubseteq t_i$, so $t$ is a lower bound of $\{t_i\}_{i\in J}$
    where $J=\{i\in I\mid a_i\neq\top\}$. By Lem.~\ref{lemma:glb-type},
    $t\sqsubseteq \sqcap_{i\in J}t_i$. Note that
    $x\to^m \sqcap_{i\in J}t_i\in \mu_I$. Therefore, we have
    $\mu'_I \sqsubseteq \mu_I$.
  \end{itemize}

  Finally, we prove that every subset of $\mathbb{AS}_\kappa$ has a least
  upper bound. Let $I\subseteq\mathbb{N}$ and
  $\{a_i\}_{i\in I}\subseteq\mathbb{AS}_\kappa$.
\end{proof}

\begin{definition}[Concretization map]\label{def:concretization}
  An abstract store $a\in\mathbb{AS}_\kappa$ represents a set of concrete stores
  in $\mathbb{S}_\kappa$, according to the \emph{concretization map}
  $\gamma_\kappa:\mathbb{AS}_\kappa\to\wp(\mathbb{S}_\kappa)$, defined as
  $\gamma_\kappa(\top)=\mathbb{S}_\kappa$ and, for $a\not=\top$,
  \[
  \gamma_\kappa(a)=\left\{\rho\star h\in\mathbb{S}_\kappa\left|\begin{array}{l}
  \text{for every }x\to^m\ell\in\rho\text{ there is }x\to^m t\in a\text{ s.t.\ }\ell\approx_{\rho\star h}t
  \end{array}
  \right.\right\}
  \]
  where
  \begin{align*}
    \ell&\approx_{\rho\star h}\mathsf{int} & \text{iff $h(\ell)\in\mathbb{Z}$}\\
    \ell&\approx_{\rho\star h}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \text{iff $\exists i.1\le i\le n$ s.t.\ }\loc(\mathsf{w}_i,s)\to\ell\in\rho\\
    \ell&\approx_{\rho\star h}\mathtt{mut}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \text{iff $\exists i.1\le i\le n$ s.t.\ }\loc(\mathsf{w}_i,s)\leadsto\ell\in\rho\\
    \ell&\approx_{\rho\star h}\mathtt{box}\ t & \text{iff $\ell\Rightarrow\ell'\in h$ and $\ell'\approx_{\rho\star h}t$}\\
    \ell&\approx_{\rho\star h}\bot & \text{iff $h(\ell)$ is undefined}
  \end{align*}
\end{definition}

\begin{lemma}\label{lem:co-additive}
  The map $\gamma_\kappa$ of Def.~\ref{def:concretization} is co-additive.
\end{lemma}
\begin{proof}
  Let $I\subseteq\mathbb{N}$ and $\{a_i\}_{i\in I}\subseteq\mathbb{AS}_\kappa$. We prove that
  $\gamma_\kappa(\sqcap_{i\in I}a_i)=\cap_{i\in I}\gamma_\kappa(a_i)$.
  \textbf{TODO}
  \qed
\end{proof}

\begin{proposition}\label{prop:abstract_interpretation}
  The domain $\mathbb{AS}_\kappa$ is an abstract interpretation of $\wp(\mathbb{S}_\kappa)$
  with $\gamma_\kappa$ as concretization map.
\end{proposition}
\begin{proof}
  The abstract domain $\mathbb{AS}_\kappa$ is a complete lattice \wrt $\sqsubseteq$
  with $\sqcap$ as greatest lower bound operator (Prop.~\ref{prop:complete_lattice}).
  The domain $\wp(\mathbb{S}_\kappa)$ is a complete lattice \wrt $\subseteq$ with $\cap$ as
  greatest lower bound operator. The map $\gamma_\kappa$ is co-additive (Lem.~\ref{lem:co-additive}).
  The thesis follows by a general result of abstract interpretation~\cite{CousotC77}.
  \qed
\end{proof}
