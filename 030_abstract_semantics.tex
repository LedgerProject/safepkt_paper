\section{Abstract Semantics}\label{sec:abstract_semantics}

\begin{definition}[Types]
  The set of \emph{types} over a context $\kappa$ (Def.~\ref{def:context}) is
  \begin{align*}
    \mathsf{T}_\kappa ::=&\ \mathsf{int} & \text{integer}\\
    | &\ \borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \text{borrow}\\
    | &\ \mathtt{mut}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \text{mutable borrow}\\
    | &\ \mathtt{box}\ \mathsf{T}_\kappa & \text{box}\\
    | &\ \bot & \text{undefined}
  \end{align*}
  where $n\ge 1$ and the $\mathsf{w}_i$, with $1\le i\le n$, are leftvalues
  using only variables in $\dom(\kappa)$. This set is ordered by $\sqsubseteq$, defined as
  \begin{align*}
    \mathsf{int}&\sqsubseteq\mathsf{int}\\
    \borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \sqsubseteq
    \borrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} \quad\text{iff $\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\subseteq\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\}$}\\
    \mathtt{mut}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \sqsubseteq
    \mathtt{mut}\borrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} \quad\text{iff $\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\subseteq\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\}$}\\
    \mathtt{box}\ t_1&\sqsubseteq\mathtt{box}\ t_2 \quad\text{iff $t_1\sqsubseteq t_2$}\\
    \bot&\sqsubseteq t\qquad\text{for every $t$.}
  \end{align*}
\end{definition}

\begin{lemma}
  \label{lemma:partial-order-types}
  $(\mathsf{T}_\kappa,\sqsubseteq)$ is a partially ordered set.
\end{lemma}
\begin{proof}
\end{proof}

\begin{definition}
  The greatest lower bound operator over $\mathsf{T}_\kappa$ is defined as
  \begin{align*}
    \mathsf{int}\sqcap\mathsf{int} &= \mathsf{int}\\
    \borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} \sqcap \borrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} &= \borrow b\\
    & \text{if $b=\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\cap\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\}\not=\varnothing$}\\
    \mathtt{mut}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} \sqcap \mathtt{mut}\borrow\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\} &= \mathtt{mut}\borrow b\\
    & \text{if $b=\{\mathsf{w}_1,\ldots,\mathsf{w}_n\}\cap\{\mathsf{w}'_1,\ldots,\mathsf{w}'_{n'}\}\not=\varnothing$}\\
    (\mathtt{box}\ t_1) \sqcap (\mathtt{box}\ t_2) &=\mathtt{box}\ (t_1\sqcap t_2).
  \end{align*}
  In all other cases, $t_1\sqcap t_2=\bot$.
\end{definition}

\begin{definition}[Abstract stores]
  \label{def:abstract-store}
  Given a context $\kappa$, an \emph{abstract store} $a$ over $\kappa$ is either $\top$
  or a set of bindings from variables to types, decorated with a lifetime:
  \[
  a\subseteq\{x\to^m t\mid x\to^m\in\kappa\text{ and }t\in\mathsf{T_\kappa}\}\cup\{\top\}
  \]
  with the constraint that exactly one binding exists for each given variable in $\dom(\kappa)$.
  The set of all abstract stores over $\kappa$ is $\mathbb{AS}_\kappa$.
  The latter is ordered by $\sqsubseteq$, defined as $a_1\sqsubseteq a_2$ iff $a_2=\top$ or
  ($a_1,a_2\not=\top$ and for every $x\to^mt_1\in a_1$ there is $x\to^mt_2\in a_2$
  such that $t_1\sqsubseteq t_2$).
\end{definition}

\begin{definition}
  The greatest lower bound operator over $\mathbb{AS}_\kappa$ is defined as
  $a\sqcap\top=a$, $\top\sqcap a=a$ and, when $a_1,a_2\not=\top$,
  \[
  a_1\sqcap a_2=\{x\to^m(t_1\sqcap t_2)\mid x\to^m t_1\in a_1\text{ and }x\to^m t_2\in a_2\}.
  \]
\end{definition}

\begin{proposition}\label{prop:complete_lattice}
  The abstract domain $\mathbb{AS}_\kappa$ is a complete lattice \wrt $\sqsubseteq$,
  with $\sqcap$ as greatest lower bound operator.
\end{proposition}
\begin{proof}
  First we prove that $(\mathbb{AS}_\kappa,\sqsubseteq)$ is a partially
  ordered set.
  \begin{itemize}
    \item (Reflexivity) By Def.~\ref{def:abstract-store}, we have
    $\top\sqsubseteq \top$. Let $a\in\mathbb{AS}_\kappa$ with $a\neq \top$.
    {\bf\color{red}If $a$ is empty, then ???}
    Otherwise, for every $x\to^mt\in a$ there is $x\to^mt\in a$ with
    $t\sqsubseteq t$ (see Lemma~\ref{lemma:partial-order-types}), hence by
    Def.~\ref{def:abstract-store} we have $a\sqsubseteq a$.
    %
    \item (Antisymmetry) Suppose that $a_1 \sqsubseteq a_2$ and
    $a_2 \sqsubseteq a_1$. If $a_2=\top$, then, as $a_2 \sqsubseteq a_1$,
    we necessarily have $a_1=\top$ by Def.~\ref{def:abstract-store}, so
    $a_1=a_2$. Otherwise, we necessarily
    have $a_1\neq\top$. Moreover, as $a_1 \sqsubseteq a_2$, for every
    $x\to^mt_1\in a_1$ there is $x\to^mt_2\in a_2$ such that
    $t_1\sqsubseteq t_2$ and, as $a_2 \sqsubseteq a_1$, there is
    $x\to^mt'_1\in a_1$ such that $t_2\sqsubseteq t'_1$.
    As in $a_1$ there is exactly one binding for $x\in\dom(\kappa)$, we have
    $t_1=t'_1$. Consequently, $t_1\sqsubseteq t_2$ and $t_2\sqsubseteq t_1$
    so, by Lemma~\ref{lemma:partial-order-types}, $t_1=t_2$. So, we have
    proved that for every $x\to^mt_1\in a_1$ we have $x\to^mt_1\in a_2$.
    Identically, by considering $a_2 \sqsubseteq a_1$, we prove that
    for every $x\to^mt_2\in a_2$ we have $x\to^mt_2\in a_1$.
    Therefore, $a_1=a_2$.
    %
    \item (Transitivity) Suppose that $a_1 \sqsubseteq a_2$ and
    $a_2 \sqsubseteq a_3$. If $a_3=\top$, then by Def.~\ref{def:abstract-store}
    we have $a_1\sqsubseteq a_3$. Otherwise, as $a_2 \sqsubseteq a_3$,
    we have $a_2\neq\top$ and so, as $a_1 \sqsubseteq a_2$, we also have
    $a_1\neq\top$. Consequently, for every $x\to^mt_1\in a_1$ there is
    $x\to^mt_2\in a_2$ such that $t_1\sqsubseteq t_2$ and there is
    $x\to^mt_3\in a_3$ such that $t_2\sqsubseteq t_3$. Hence, by
    Lemma~\ref{lemma:partial-order-types}, we have $t_1\sqsubseteq t_3$.
    Therefore, by Def.~\ref{def:abstract-store}, we have $a_1\sqsubseteq a_3$.
  \end{itemize}

  Now we prove that every subset of $\mathbb{AS}_\kappa$ has a greatest
  lower bound.

  Finally, we prove that every subset of $\mathbb{AS}_\kappa$ has a least
  upper bound.
\end{proof}

\begin{definition}[Concretization map]\label{def:concretization}
  An abstract store $a\in\mathbb{AS}_\kappa$ represents a set of concrete stores
  in $\mathbb{S}_\kappa$, according to the \emph{concretization map}
  $\gamma_\kappa:\mathbb{AS}_\kappa\to\wp(\mathbb{S}_\kappa)$, defined as
  $\gamma_\kappa(\top)=\mathbb{S}_\kappa$ and, for $a\not=\top$,
  \[
  \gamma_\kappa(a)=\left\{\rho\star h\in\mathbb{S}_\kappa\left|\begin{array}{l}
  \text{for every }x\to^m\ell\in\rho\text{ there is }x\to^m t\in a\text{ s.t.\ }\ell\approx_{\rho\star h}t
  \end{array}
  \right.\right\}
  \]
  where
  \begin{align*}
    \ell&\approx_{\rho\star h}\mathsf{int} & \text{iff $h(\ell)\in\mathbb{Z}$}\\
    \ell&\approx_{\rho\star h}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \text{iff $\exists i.1\le i\le n$ s.t.\ }\loc(\mathsf{w}_i,s)\to\ell\in\rho\\
    \ell&\approx_{\rho\star h}\mathtt{mut}\borrow\{\mathsf{w}_1,\ldots,\mathsf{w}_n\} & \text{iff $\exists i.1\le i\le n$ s.t.\ }\loc(\mathsf{w}_i,s)\leadsto\ell\in\rho\\
    \ell&\approx_{\rho\star h}\mathtt{box}\ t & \text{iff $\ell\Rightarrow\ell'\in h$ and $\ell'\approx_{\rho\star h}t$}\\
    \ell&\approx_{\rho\star h}\bot & \text{iff $h(\ell)$ is undefined}
  \end{align*}
\end{definition}

\begin{lemma}\label{lem:co-additive}
  The map $\gamma_\kappa$ of Def.~\ref{def:concretization} is co-additive.
\end{lemma}
\begin{proof}
  Let $I\subseteq\mathbb{N}$ and $\{a_i\}_{i\in I}\subseteq\mathbb{AS}_\kappa$. We prove that
  $\gamma_\kappa(\sqcap_{i\in I}a_i)=\cap_{i\in I}\gamma_\kappa(a_i)$.
  \textbf{TODO}
  \qed
\end{proof}

\begin{proposition}\label{prop:abstract_interpretation}
  The domain $\mathbb{AS}_\kappa$ is an abstract interpretation of $\wp(\mathbb{S}_\kappa)$
  with $\gamma_\kappa$ as concretization map.
\end{proposition}
\begin{proof}
  The abstract domain $\mathbb{AS}_\kappa$ is a complete lattice \wrt $\sqsubseteq$
  with $\sqcap$ as greatest lower bound operator (Prop.~\ref{prop:complete_lattice}).
  The domain $\wp(\mathbb{S}_\kappa)$ is a complete lattice \wrt $\subseteq$ with $\cap$ as
  greatest lower bound operator. The map $\gamma_\kappa$ is co-additive (Lem.~\ref{lem:co-additive}).
  The thesis follows by a general result of abstract interpretation~\cite{CousotC77}.
  \qed
\end{proof}
