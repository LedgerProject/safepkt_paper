\section{Semantics}\label{sec:semantics}

\begin{definition}
  We assume there is a set of variables $\Vars$
  and a finite set $\Lifetimes$ of \emph{lifetimes}.
  The set of \emph{leftvalues} \textsf{w} is defined as:
  \begin{align*}
    \mathsf{w} ::= &\ x & \text{variable, with $x\in\Vars$}\\
    | &\ \mathtt{*}\mathsf{w} & \text{dereference}
  \end{align*}
  The set of \emph{expressions} \textsf{e} is defined as
  \begin{align*}
    \mathsf{e} ::= &\ i & \text{integer}\\
    | &\ \mathsf{w} & \text{leftvalue}\\
    | &\ \borrow\mathsf{w} & \text{borrow}\\
    | &\ \mathtt{mut}\borrow\mathsf{w} & \text{mutable borrow}\\
    | &\ \mathtt{box}\ \mathsf{e} & \text{heap allocation}
  \end{align*}
  The sets of \emph{terms} \textsf{t} and \emph{blocks} \textsf{b}
  is defined as:
  \begin{align*}
    \mathsf{t} ::= &\ \mathsf{w}=\mathsf{e} & \text{assignment}\\
    | &\ \mathtt{let\ mut}\ x=\mathsf{e} & \text{declaration, with $x\in\Vars$}\\
    | &\ \mathsf{b} & \text{block}
  \end{align*}
  and
  \begin{align*}
    \mathsf{b} ::= &\ \{\mathsf{t_1};\ldots;\mathsf{t_n}\}^l & \text{with $n\ge 0$ and $l\in\Lifetimes$}
  \end{align*}
\end{definition}

\begin{example}\label{ex:program}
  The following valid program consists of a block that contains an inner block.
  \[
    \{
      \mathtt{let\ mut}\ x = \mathtt{box}\ 0;\
      \{\mathtt{let\ mut}\ y = \mathtt{mut}\borrow x;\
      \mathtt{*}y = \mathtt{box}\ 1\}^m;\
      \mathtt{let\ mut}\ z = x
    \}^l
  \]
\end{example}

\begin{definition}
  We assume that there is an infinite set $\Locs$ of \emph{locations}.
  The set of \emph{values} is defined as $\mathbb{V}=\mathbb{Z}\cup\Locs$,
  where $\mathbb{Z}$ is the set of integers.

  The set $\mathbb{E}$
  of \emph{environments} contains bindings from variables to locations,
  decorated with a \emph{lifetime} and existing in two versions, owned
  and not owned:
  \[
  \mathbb{E}=
  \underbrace{\left\{x\Rightarrow^m\ell\left|\begin{array}{l}
  x\in\Vars,\ m\in\Lifetimes\\
  \text{and }\ell\in\Locs
  \end{array}\right.\right\}}_{\text{owned bindings}}
  \cup
  \underbrace{\left\{x\rightarrow^m\ell\left|\begin{array}{l}
  x\in\Vars,\ m\in\Lifetimes\\
  \text{and }\ell\in\Locs
  \end{array}\right.\right\}}_{\text{not owned bindings}}
  \]
  with the constraint that, for each $\rho\in\mathbb{E}$, there is at most a binding for each
  given variable $x$ (owned or not owned). Moreover, we write $\rho(x)=\ell$ and
  $\rho^+(x)=\ell^m$ when
  either $x\Rightarrow^m\ell\in\rho$ or $x\rightarrow^m\ell\in\rho$, for some $m$.

  The set $\mathbb{H}$ of \emph{heaps} contains bindings from locations to values,
  existing in two versions, owned and not owned:
  \[
  \mathbb{H}=
  \underbrace{\{\ell\Rightarrow v\mid\ell\in\Locs\text{ and }v\in\mathbb{V}\}}_{\text{owned bindings}}
  \cup
  \underbrace{\{\ell\rightarrow v\mid\ell\in\Locs\text{ and }v\in\mathbb{V}\}}_{\text{not owned bindings}}
  \]
  with the constraint that, for each $h\in\mathbb{H}$, there is at most a binding for each
  location $\ell$ (owned or not owned). We write $h(\ell)=v$ meaning that
  either $\ell\Rightarrow v\in h$ or $\ell\rightarrow v\in h$. Given $L\subseteq\Locs$,
  we write $h|_{-L}$ meaning $h$ where the bindings for the locations in $L$
  have been removed (if any).

  The set of \emph{stores} $\mathbb{S}$ is the set of pairs
  $\mathbb{E}\times\mathbb{H}$, whose elements are written as $\rho\star h$.
  Given $s=\rho\star h\in\mathbb{S}$, we define $s(x)=\rho(x)$
  and $s^+(x)=\rho^+(x)$ for all
  $x\in\Vars$ and $s(\ell)=h(\ell)$ for all $\ell\in\Locs$.
  Given $L\subseteq\Locs$, we define $(\rho\star h)|_{-L}=\rho\star(h|_{-L})$.
\end{definition}

\begin{definition}[Locate]
  The partial function $\loc(\mathsf{w},s)$ determines the location that holds
  the value of the leftvalue $\mathsf{w}$ in $s\in\mathbb{S}$, as follows:
  \begin{align*}
    \loc(x,s) &= s(x)\\
    \loc(*\mathsf{w},s) &= s(\loc(\mathsf{w},s))
  \end{align*}
\end{definition}

\begin{example}
  Let $x$ be a variable, $m$ be a lifetime and
  $s = \rho\star h$ be a store with
  $\rho = \left\{x\rightarrow^m\ell_x\right\}$
  and $h = \left\{\ell_x\rightarrow^m\ell,\ \ell\rightarrow^m 1\right\}$.
  Then we have
  \[\loc(\mathtt{*}x,s) = s(\loc(x,s)) = s(s(x)) = s(\rho(x))
  = s(\ell_x) = h(\ell_x) = \ell\;.\]
\end{example}

%\begin{definition}[Read]
%  The partial function $\readlv(s,\mathsf{w})$ retrieves the value of
%  the leftvalue $\mathsf{w}$ in $s\in\mathbb{S}$, as follows:
%  \[
%  \readlv(s,\mathsf{w})=s(\loc(s,\mathsf{w}))
%  \]
%\end{definition}

The evaluation of a leftvalue yields the value of the leftvalue and a potentially updated heap:

\begin{definition}[Semantics of leftvalues]\label{def:semantics_leftvalues}
  Given $s=\rho\star h$, we define
  \[
  \den[\mathsf{w}]{s}=\begin{cases}
  \langle s(\loc(\mathsf{w},s)), h\rangle & \text{if the static type of $\mathsf{w}$ has copy semantics}\\
  \langle s(\loc(\mathsf{w},s)), h|_{-\loc(\mathsf{w},s)}\rangle & \text{if the static type of $\mathsf{w}$ has move semantics}
  \end{cases}
  \]
\end{definition}

\noindent
Note that the second case above makes $\mathsf{w}$ point to a dangling location, hence
$\mathsf{w}$ becomes unusable.

The evaluation of an expression yields the value of the expression and a potentially updated heap:

\begin{definition}[Semantics of expressions]\label{def:semantics_expressions}
  Given $s=\rho\star h$, we define
  \begin{align*}
    \den[i]{s}&=\langle i,h\rangle\\
    \den[\borrow\mathsf{w}]{s}&=\langle\loc(\mathsf{w},s),h\rangle\\
    \den[\mathtt{mut}\borrow\mathsf{w}]{s}&=\langle\loc(\mathsf{w},s),h\rangle\\
    \den[\mathtt{box}\ \mathsf{e}]{s}&=\langle\ell,h'\cup\{\ell\Rightarrow v\}\rangle
    & \text{where $\ell$ is fresh and $\den[\mathsf{e}]{s}=\langle v, h'\rangle$}
  \end{align*}
  For expressions that are leftvalues, see Def.~\ref{def:semantics_leftvalues}.
\end{definition}

The set of locations reachable by following owned bindings only, and starting from a set of locations $\psi$,
is defined as follows:
%
\begin{definition}[Owned reachable locations]
  Given $\psi\subseteq\Locs$ and $h\in\mathbb{H}$, we define
  \begin{align*}
  \omega^0(\psi,h)&=\{\ell'\in\Locs\mid\ell\in\psi\text{ and }\ell\Rightarrow\ell'\in h\}\\
  \omega^{i+1}(\psi,h)&=\{\ell'\in\Locs\mid\ell\in\omega^i(\psi,h)\text{ and }\ell\Rightarrow\ell'\in h\}
  \end{align*}
  and
  \[
  \omega(\psi,h)=\bigcup\limits_{i\ge 0}\omega^i(\psi,h)~.
  \]
\end{definition}

The function $\drop$ removes the owned locations reachable from a set of locations.
%
\begin{definition}[Drop]\label{def:drop}
  The function $\drop:\wp(\Locs)\times\mathbb{H}\to\mathbb{H}$ is defined as
  \[
  \drop(\psi,h)=h|_{-{\omega(\psi,h)}}~.
  \]
\end{definition}

\begin{definition}[Semantics of assignment]\label{def:semantics_assigmment}
  Given $s=\rho\star h$ and $l\in\Lifetimes$, we define
  \begin{align*}
    \denl[\mathsf{w}=\mathsf{e}]{l}{s}&=\langle\rho,h''[\ell\Rightarrow v]\rangle & \text{if the static type of $\mathsf{e}$ has copy semantics}\\
    \denl[\mathsf{w}=\mathsf{e}]{l}{s}&=\langle\rho,h''[\ell\to v]\rangle & \text{if the static type of $\mathsf{e}$ has move semantics}
  \end{align*}
  where $\den[\mathsf{e}]{s}=\langle v,h'\rangle$, $\ell=\loc(\mathsf{w},\langle\rho,h'\rangle)$ and
  $h''=\drop(\{\ell\},h')$.
\end{definition}

\begin{example}
  Consider again the program of Ex.~\ref{ex:program}:
  \[
    \{
      \mathtt{let\ mut}\ x = \mathtt{box}\ 0;\
      \{\mathtt{let\ mut}\ y = \mathtt{mut}\borrow x;\
      \mathtt{*}y = \mathtt{box}\ 1\}^m;\
      \mathtt{let\ mut}\ z = x
    \}^l
  \]
  Let $\rho=\left\{x\rightarrow^l\ell_x,
  y\rightarrow^m\ell_y,
  z\rightarrow^l\ell_z\right\}$.
  Let $h=\emptyset$ be the heap before execution of the first statement.
  % After execution of the first statement, we have $\loc(x,s) = \ell_1$.
  % After execution of the inner block, we have $\loc(x,s) = \loc(y,s) = \ell_2$
  % and after execution of the final statement we have
  % $\loc(x,s) = \loc(y,s) = \loc(z,s) = \ell_2$.
\end{example}
